# Руководство по прошивке STM32 через UART

## Обзор

Данное руководство описывает процесс настройки Raspberry Pi для прошивки STM32 микроконтроллеров через UART без использования ST-Link.

## Настройка завершена

✅ **UART настроен**: Создан симлинк `/dev/serial0` → `/dev/ttyS0`  
✅ **stm32flash установлен**: Утилита для прошивки STM32 по UART  
✅ **Скрипты созданы**: Автоматизация процесса прошивки  

## Доступные скрипты

### 1. Проверка связи с загрузчиком
```bash
./check_bootloader.sh
```
Проверяет доступность загрузчика STM32 на всех доступных портах.

### 2. Прошивка основной программы
```bash
./flash.sh firmware.bin
```
Прошивает файл прошивки в STM32 и запускает программу.

## Порты UART

- **USB-TTL адаптер**: `/dev/ttyUSB0` (рекомендуется)
- **Встроенный UART**: `/dev/ttyS0` (симлинк `/dev/serial0`)

## Как использовать

### Шаг 1: Подготовка платы STM32

1. **Подключите плату STM32** к Raspberry Pi через USB-TTL адаптер:
   - TX платы → RX адаптера
   - RX платы → TX адаптера
   - GND платы → GND адаптера
   - 3.3V платы → 3.3V адаптера

2. **Включите питание** платы STM32

### Шаг 2: Активация загрузчика

**Способ A: Двойной сброс (рекомендуется)**
1. Нажмите кнопку RESET на плате **дважды быстро** (в течение 0.5 сек)
2. Светодиод на PC13 должен начать **часто мигать** — это режим ожидания прошивки

**Способ B: Автосброс через RTS (если поддерживается)**
- Подключите RTS адаптера к RESET платы через конденсатор 0.1 мкФ

### Шаг 3: Проверка связи

```bash
./check_bootloader.sh
```

Если загрузчик найден, вы увидите:
```
✓ Загрузчик найден на /dev/ttyUSB0!
Device ID: 0x0410 (STM32F103C8/CB)
```

### Шаг 4: Прошивка

```bash
./flash.sh your_firmware.bin
```

## Структура прошивки

- **Загрузчик**: Адрес 0x08000000 (generic_boot20_pc13.bin)
- **Основная программа**: Адрес 0x08002000 (ваша прошивка)

## Устранение неполадок

### Загрузчик не найден

1. **Проверьте подключение**:
   - TX/RX перепутаны местами
   - Плохой контакт
   - Неправильное питание

2. **Проверьте загрузчик**:
   - Нажмите RESET дважды быстро
   - Светодиод должен мигать часто

3. **Проверьте порт**:
   - Убедитесь, что порт не занят Docker контейнером
   - Попробуйте другой порт

### Ошибки прошивки

1. **"Failed to init device"**:
   - Загрузчик не активен
   - Неправильная скорость передачи
   - Проблемы с подключением

2. **"Write failed"**:
   - Плата не в режиме загрузчика
   - Проблемы с питанием
   - Неправильный формат файла

## Команды stm32flash

### Базовая информация
```bash
stm32flash /dev/ttyUSB0
```

### Прошивка с проверкой
```bash
stm32flash -b 115200 -m 8n1 -w firmware.bin -v -g 0x08002000 /dev/ttyUSB0
```

### Параметры
- `-b 115200`: Скорость передачи
- `-m 8n1`: Режим (8 бит, без четности, 1 стоп-бит)
- `-w file.bin`: Записать файл
- `-v`: Проверить после записи
- `-g 0x08002000`: Запустить по адресу

## Интеграция с Docker

Скрипты автоматически управляют Docker контейнером `hoverboard`:
- Останавливают контейнер перед прошивкой
- Запускают контейнер после завершения

## Безопасность

- Всегда проверяйте файл прошивки перед загрузкой
- Делайте резервные копии рабочей прошивки
- Используйте правильный адрес загрузки (0x08002000)

## Поддержка

При возникновении проблем:
1. Проверьте логи: `sudo dmesg | grep tty`
2. Проверьте права доступа: `groups $USER`
3. Проверьте занятость порта: `sudo lsof /dev/ttyUSB0`

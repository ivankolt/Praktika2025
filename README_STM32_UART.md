# Прошивка STM32 через UART на Raspberry Pi

## Обзор

Данная система позволяет прошивать микроконтроллеры STM32 через UART без использования ST-Link, используя встроенный загрузчик STM32.

## Подготовка

### 1. Установка stm32flash

```bash
sudo apt update
sudo apt install git build-essential
git clone https://github.com/stm32duino/stm32flash.git
cd stm32flash
make
sudo make install
```

### 2. Проверка системы

Запустите скрипт диагностики:
```bash
./setup_uart.sh
```

## Подключение

### Схема подключения USB-TTL адаптера к STM32:

```
USB-TTL адаптер    STM32
├─ TX (зеленый)  → PA10 (RX)
├─ RX (белый)    → PA9  (TX)  
├─ GND (черный)  → GND
└─ 3.3V (красный)→ 3.3V
```

**Важно:** TX и RX подключаются перекрестно!

## Режимы работы загрузчика

### Способ 1: Автоматический сброс (рекомендуется)

Если ваш USB-TTL адаптер поддерживает RTS/DTR:

```bash
./flash_with_reset.sh firmware.bin
```

### Способ 2: Двойной сброс

1. Быстро нажмите кнопку RESET дважды (в течение 0.5 сек)
2. Светодиод на PC13 начнет часто мигать
3. Запустите прошивку:

```bash
./flash.sh firmware.bin
```

### Способ 3: Ручной сброс

1. Нажмите RESET на плате
2. Сразу запустите команду:

```bash
./flash.sh firmware.bin
```

## Команды прошивки

### Основные команды

```bash
# Прошивка с проверкой и запуском
stm32flash -w firmware.bin -v -g 0x08002000 /dev/ttyUSB0

# С увеличенной скоростью
stm32flash -b 230400 -w firmware.bin -v -g 0x08002000 /dev/ttyUSB0

# С автоматическим сбросом
stm32flash -R -b 230400 -w firmware.bin -v -g 0x08002000 /dev/ttyUSB0
```

### Параметры команды

- `-w` - записать файл
- `-v` - проверить после записи  
- `-g 0x08002000` - запустить прошивку по адресу 0x08002000
- `-b 230400` - скорость передачи (по умолчанию 57600)
- `-R` - сброс устройства при выходе
- `/dev/ttyUSB0` - порт UART

## Скрипты

### setup_uart.sh
Диагностика системы и проверка подключения

### flash.sh  
Прошивка с ручным управлением сбросом

### flash_with_reset.sh
Прошивка с автоматическим сбросом через RTS

## Устранение неполадок

### Ошибка "Device not found"
- Проверьте подключение TX/RX (должно быть перекрестно)
- Убедитесь, что плата в режиме загрузчика
- Проверьте питание платы

### Ошибка "Permission denied"
```bash
sudo usermod -a -G dialout $USER
# Перелогиньтесь или выполните:
newgrp dialout
```

### Ошибка "Port busy"
```bash
sudo fuser -k /dev/ttyUSB0
```

### Загрузчик не отвечает
1. Убедитесь, что загрузчик записан по адресу 0x08000000
2. Попробуйте двойной сброс
3. Проверьте скорость передачи (попробуйте -b 115200)

## Адреса памяти

- **Загрузчик:** 0x08000000 - 0x08001FFF (8KB)
- **Основная прошивка:** 0x08002000 - 0x0801FFFF (120KB)

## Возврат к ST-Link

В любой момент можно вернуться к использованию ST-Link:
- ST-Link может перепрошить всю память
- Можно заменить загрузчик на заводской
- Никаких ограничений нет

## Примеры использования

```bash
# Проверка системы
./setup_uart.sh

# Прошивка с автосбросом
./flash_with_reset.sh my_firmware.bin

# Прошивка с ручным сбросом
./flash.sh my_firmware.bin

# Прямая команда
sudo stm32flash -R -b 230400 -w my_firmware.bin -v -g 0x08002000 /dev/ttyUSB0
```

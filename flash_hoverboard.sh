#!/bin/bash

# Скрипт для прошивки платы hoverboard через UART
# Использование: ./flash_hoverboard.sh [файл_прошивки]

FIRMWARE_FILE=${1:-"test_firmware.bin"}
UART_DEVICE="/dev/ttyUSB0"

echo "=== Прошивка платы hoverboard ==="
echo "Файл прошивки: $FIRMWARE_FILE"
echo "UART устройство: $UART_DEVICE"
echo ""

# Проверяем существование файла прошивки
if [ ! -f "$FIRMWARE_FILE" ]; then
    echo "Ошибка: Файл прошивки '$FIRMWARE_FILE' не найден!"
    exit 1
fi

# Проверяем существование UART устройства
if [ ! -e "$UART_DEVICE" ]; then
    echo "Ошибка: UART устройство '$UART_DEVICE' не найдено!"
    echo "Убедитесь, что USB-UART адаптер подключен."
    exit 1
fi

echo "Инструкции для активации загрузчика:"
echo "1. Если плата выключена - включите её и сразу запустите этот скрипт"
echo "2. Если плата уже включена - быстро нажмите кнопку RESET 2 раза"
echo "3. Светодиод на PC13 должен начать часто мигать (режим ожидания)"
echo ""
echo "Нажмите Enter когда будете готовы..."
read

# Пробуем разные скорости передачи данных
SPEEDS=(57600 115200 9600 230400)

for speed in "${SPEEDS[@]}"; do
    echo "Попытка подключения на скорости $speed baud..."
    
    # Пробуем подключиться к загрузчику
    if stm32flash -b $speed "$UART_DEVICE" > /dev/null 2>&1; then
        echo "✓ Связь с загрузчиком установлена на скорости $speed baud"
        echo "Начинаем прошивку..."
        
        # Прошиваем плату
        if stm32flash -b $speed -w "$FIRMWARE_FILE" -v -g 0x08002000 "$UART_DEVICE"; then
            echo "✓ Прошивка завершена успешно!"
            echo "Плата перезагружена и готова к работе."
            exit 0
        else
            echo "✗ Ошибка при прошивке на скорости $speed baud"
        fi
    else
        echo "✗ Не удалось подключиться на скорости $speed baud"
    fi
    
    echo ""
done

echo "❌ Не удалось подключиться к загрузчику на всех скоростях"
echo ""
echo "Возможные причины:"
echo "1. Плата не подключена к USB-UART адаптеру"
echo "2. Загрузчик не активен (нужен двойной сброс или включение платы)"
echo "3. Неправильное подключение TX/RX проводов"
echo "4. Плата не получает питание"
echo ""
echo "Попробуйте:"
echo "1. Проверить подключение проводов (TX платы -> RX адаптера, RX платы -> TX адаптера)"
echo "2. Убедиться, что плата получает питание"
echo "3. Сделать двойной сброс (быстро нажать RESET 2 раза)"
echo "4. Перезапустить скрипт"

exit 1
